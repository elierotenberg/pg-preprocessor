'use strict';

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

exports.__esModule = true;

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

_bluebird2['default'].promisifyAll(_fs2['default']);

var DIRECTIVE_PREFIX = '-- @';

var DIRECTIVE_REGEXP = /^\-\- \@([^ ]*) (.*)$/;

var DECLARE_REGEXP = /^(local|global) ([^ ]*) (.*)$/;

var defaultOpts = {
  basePath: process.cwd(),
  encoding: 'utf8',
  blacklist: []
};

var directives = {};

function startsWith(originString, searchString, position) {
  position = position || 0;
  return originString.indexOf(searchString, position) === position;
}

function resolveWithoutExt(opts, _ref, path) {
  var entry = _ref.entry;

  if (startsWith(path, '.')) {
    var _p$parse = _path2['default'].parse(entry);

    var dir = _p$parse.dir;

    return _path2['default'].resolve(dir, path);
  }
  return _path2['default'].resolve(opts.basePath, path);
}

function resolve(opts, _ref2, path) {
  var entry = _ref2.entry;

  var pathWithoutExt = resolveWithoutExt(opts, { entry: entry }, path);
  if (_path2['default'].extname(pathWithoutExt) === '') {
    return pathWithoutExt + '.sql';
  }
  return pathWithoutExt;
}

function escapeRegExp(string) {
  return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, '\\$1');
}

function replaceAll(string, original, replaced) {
  return string.replace(new RegExp(escapeRegExp(original), 'g'), replaced);
}

function processNextDirective(opts, state) {
  var linesAlreadyProcessed = state.linesAlreadyProcessed;
  var linesToProcess = state.linesToProcess;

  var indexOfFirstDirective = _lodash2['default'].findIndex(linesToProcess, function (line) {
    return startsWith(line, DIRECTIVE_PREFIX);
  });
  if (indexOfFirstDirective === -1) {
    _lodash2['default'].each(linesToProcess, function (line) {
      return linesAlreadyProcessed.push(line);
    });
    return linesAlreadyProcessed;
  }
  var firstDirective = linesToProcess[indexOfFirstDirective];
  var linesToIgnore = _lodash2['default'].slice(linesToProcess, 0, indexOfFirstDirective);
  var nextLinesToProcess = _lodash2['default'].slice(linesToProcess, indexOfFirstDirective);
  var params = firstDirective.match(DIRECTIVE_REGEXP);
  if (params === null) {
    throw new Error('Unrecognized directive in ' + state.entry + ': ' + firstDirective);
  }
  var directiveName = params[1];
  var directiveArgs = params[2];

  if (!_lodash2['default'].has(directives, directiveName)) {
    throw new Error('Unknown directive in ' + state.entry + ': ' + directiveName);
  }
  if (_lodash2['default'].includes(opts.blacklist, directiveName)) {
    return directives._noop(opts, state);
  }
  _lodash2['default'].each(linesToIgnore, function (line) {
    return linesAlreadyProcessed.push(line);
  });
  state.linesToProcess = nextLinesToProcess;
  return directives[directiveName](opts, state, directiveArgs);
}

function processSingleFile(opts, state) {
  var entry = state.entry;
  var globalDecls = state.globalDecls;
  var localDecls = state.localDecls;

  return _fs2['default'].readFileAsync(entry).then(function (contents) {
    var decls = _Object$assign({}, globalDecls, localDecls);
    var linesToProcess = _lodash2['default'].reduce(decls, function (current, expr, identifier) {
      return replaceAll(current, expr, identifier);
    }, replaceAll(contents.toString(opts.encoding), '\r\n', '\n')).split('\n');
    return processNextDirective(opts, _Object$assign(state, { linesAlreadyProcessed: [], linesToProcess: linesToProcess }));
  });
}

_Object$assign(directives, {
  _noop: function _noop(opts, state) {
    var linesAlreadyProcessed = state.linesAlreadyProcessed;
    var linesToProcess = state.linesToProcess;

    linesAlreadyProcessed.push(linesToProcess.shift());
    return processNextDirective(opts, _Object$assign(state, { linesAlreadyProcessed: linesAlreadyProcessed, linesToProcess: linesToProcess }));
  },

  require: function require(opts, state, path) {
    var alreadyRequired = state.alreadyRequired;
    var globalDecls = state.globalDecls;
    var includeStack = state.includeStack;

    var childEntry = resolve(opts, state, path);
    if (_lodash2['default'].has(alreadyRequired, childEntry)) {
      var linesAlreadyProcessed = state.linesAlreadyProcessed;
      var linesToProcess = state.linesToProcess;

      linesToProcess.shift();
      linesAlreadyProcessed.push('-- REQUIRE ALREADY REQUIRED ' + path);
      return processNextDirective(opts, _Object$assign(state, { linesAlreadyProcessed: linesAlreadyProcessed, linesToProcess: linesToProcess }));
    }
    alreadyRequired[childEntry] = true;
    var childIncludeStack = _lodash2['default'].clone(includeStack);
    var childGlobalDecls = _lodash2['default'].clone(globalDecls);
    childIncludeStack.push(childEntry);
    var childState = {
      entry: childEntry,
      linesToProcess: null,
      linesAlreadyProcessed: null,
      localDecls: {},
      globalDecls: childGlobalDecls,
      alreadyRequired: alreadyRequired,
      includeStack: childIncludeStack
    };
    return processSingleFile(opts, childState).then(function (childLines) {
      alreadyRequired[childEntry] = childLines;
      var linesAlreadyProcessed = state.linesAlreadyProcessed;
      var linesToProcess = state.linesToProcess;

      linesToProcess.shift();
      linesAlreadyProcessed.push('-- REQUIRE BEGIN ' + path);
      _lodash2['default'].each(childLines, function (line) {
        return linesAlreadyProcessed.push(line);
      });
      var newGlobalDecls = {};
      _lodash2['default'].each(childGlobalDecls, function (expr, identifier) {
        if (!_lodash2['default'].has(globalDecls, identifier)) {
          newGlobalDecls[identifier] = expr;
        }
      });
      _lodash2['default'].each(linesToProcess, function (line, k) {
        return _lodash2['default'].each(newGlobalDecls, function (expr, identifier) {
          return linesToProcess[k] = replaceAll(linesToProcess[k], identifier, expr);
        });
      });
      linesAlreadyProcessed.push('-- REQUIRE END ' + path);
      return processNextDirective(opts, _Object$assign(state, { linesAlreadyProcessed: linesAlreadyProcessed, linesToProcess: linesToProcess }));
    });
  },

  include: function include(opts, state, path) {
    var globalDecls = state.globalDecls;
    var alreadyRequired = state.alreadyRequired;
    var includeStack = state.includeStack;

    var childEntry = resolve(opts, state, path);
    if (_lodash2['default'].includes(includeStack, childEntry)) {
      throw new Error('Cyclic include is not allowed: ' + path);
    }
    var childIncludeStack = _lodash2['default'].clone(includeStack);
    childIncludeStack.push(childEntry);
    var childState = {
      entry: childEntry,
      linesToProcess: null,
      linesAlreadyProcessed: null,
      localDecls: {},
      globalDecls: globalDecls,
      alreadyRequired: alreadyRequired,
      includeStack: childIncludeStack
    };
    return processSingleFile(opts, childState).then(function (childLines) {
      console.warn({ childLines: childLines });
      var linesAlreadyProcessed = state.linesAlreadyProcessed;
      var linesToProcess = state.linesToProcess;

      linesToProcess.shift();
      linesAlreadyProcessed.push('-- INCLUDE BEGIN ' + childEntry);
      _lodash2['default'].each(childLines, function (line) {
        return linesAlreadyProcessed.push(line);
      });
      linesAlreadyProcessed.push('-- INCLUDE END ' + childEntry);
      return processNextDirective(opts, _Object$assign(state, { linesAlreadyProcessed: linesAlreadyProcessed, linesToProcess: linesToProcess }));
    });
  },

  declare: function declare(opts, state, args) {
    var match = args.match(DECLARE_REGEXP);
    if (match === null) {
      throw new Error('Unrecognized declare: ' + args);
    }
    var localOrGlobal = match[1];
    var identifier = match[2];
    var expr = match[3];

    if (localOrGlobal === 'local') {
      state.localDecls[identifier] = expr;
    }
    if (localOrGlobal === 'global') {
      state.globalDecls[identifier] = expr;
    }
    var linesAlreadyProcessed = state.linesAlreadyProcessed;
    var linesToProcess = state.linesToProcess;

    linesAlreadyProcessed.push(linesToProcess.shift());
    _lodash2['default'].each(linesToProcess, function (line, k) {
      return linesToProcess[k] = replaceAll(line, identifier, expr);
    });
    return processNextDirective(opts, _Object$assign(state, { linesAlreadyProcessed: linesAlreadyProcessed, linesToProcess: linesToProcess }));
  }
});

function processDirectives(opts, entry) {
  _lodash2['default'].defaults(opts, defaultOpts);
  var state = {
    entry: entry,
    linesToProcess: null,
    linesAlreadyProcessed: null,
    localDecls: {},
    globalDecls: {},
    alreadyRequired: {},
    includeStack: [entry]
  };
  return processSingleFile(opts, state).then(function (lines) {
    return lines.join('\n');
  });
}

exports['default'] = processDirectives;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,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QUFFLENBQUM7YUFBSyxjQUFjLENBQUMsQ0FBQyxDQUFDLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDO0tBQUEsQ0FBQyxDQUFDO0FBQzVGLFdBQU8sb0JBQW9CLENBQUMsSUFBSSxFQUFFLGVBQWMsS0FBSyxFQUFFLEVBQUUscUJBQXFCLEVBQXJCLHFCQUFxQixFQUFFLGNBQWMsRUFBZCxjQUFjLEVBQUUsQ0FBQyxDQUFDLENBQUM7R0FDcEc7Q0FDRixDQUFDLENBQUM7O0FBRUgsU0FBUyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFO0FBQ3RDLHNCQUFFLFFBQVEsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7QUFDOUIsTUFBTSxLQUFLLEdBQUc7QUFDWixTQUFLLEVBQUwsS0FBSztBQUNMLGtCQUFjLEVBQUUsSUFBSTtBQUNwQix5QkFBcUIsRUFBRSxJQUFJO0FBQzNCLGNBQVUsRUFBRSxFQUFFO0FBQ2QsZUFBVyxFQUFFLEVBQUU7QUFDZixtQkFBZSxFQUFFLEVBQUU7QUFDbkIsZ0JBQVksRUFBRSxDQUFDLEtBQUssQ0FBQztHQUN0QixDQUFDO0FBQ0YsU0FBTyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQ3BDLElBQUksQ0FBQyxVQUFDLEtBQUs7V0FBSyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztHQUFBLENBQUMsQ0FBQztDQUNwQzs7cUJBRWMsaUJBQWlCIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xyXG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xyXG5pbXBvcnQgcCBmcm9tICdwYXRoJztcclxuUHJvbWlzZS5wcm9taXNpZnlBbGwoZnMpO1xyXG5cclxuY29uc3QgRElSRUNUSVZFX1BSRUZJWCA9ICctLSBAJztcclxuXHJcbmNvbnN0IERJUkVDVElWRV9SRUdFWFAgPSAvXlxcLVxcLSBcXEAoW14gXSopICguKikkLztcclxuXHJcbmNvbnN0IERFQ0xBUkVfUkVHRVhQID0gL14obG9jYWx8Z2xvYmFsKSAoW14gXSopICguKikkLztcclxuXHJcbmNvbnN0IGRlZmF1bHRPcHRzID0ge1xyXG4gIGJhc2VQYXRoOiBwcm9jZXNzLmN3ZCgpLFxyXG4gIGVuY29kaW5nOiAndXRmOCcsXHJcbiAgYmxhY2tsaXN0OiBbXSxcclxufTtcclxuXHJcbmNvbnN0IGRpcmVjdGl2ZXMgPSB7fTtcclxuXHJcbmZ1bmN0aW9uIHN0YXJ0c1dpdGgob3JpZ2luU3RyaW5nLCBzZWFyY2hTdHJpbmcsIHBvc2l0aW9uKSB7XHJcbiAgcG9zaXRpb24gPSBwb3NpdGlvbiB8fCAwO1xyXG4gIHJldHVybiBvcmlnaW5TdHJpbmcuaW5kZXhPZihzZWFyY2hTdHJpbmcsIHBvc2l0aW9uKSA9PT0gcG9zaXRpb247XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlc29sdmVXaXRob3V0RXh0KG9wdHMsIHsgZW50cnkgfSwgcGF0aCkge1xyXG4gIGlmKHN0YXJ0c1dpdGgocGF0aCwgJy4nKSkge1xyXG4gICAgY29uc3QgeyBkaXIgfSA9IHAucGFyc2UoZW50cnkpO1xyXG4gICAgcmV0dXJuIHAucmVzb2x2ZShkaXIsIHBhdGgpO1xyXG4gIH1cclxuICByZXR1cm4gcC5yZXNvbHZlKG9wdHMuYmFzZVBhdGgsIHBhdGgpO1xyXG59XHJcblxyXG5mdW5jdGlvbiByZXNvbHZlKG9wdHMsIHsgZW50cnkgfSwgcGF0aCkge1xyXG4gIGNvbnN0IHBhdGhXaXRob3V0RXh0ID0gcmVzb2x2ZVdpdGhvdXRFeHQob3B0cywgeyBlbnRyeSB9LCBwYXRoKTtcclxuICBpZihwLmV4dG5hbWUocGF0aFdpdGhvdXRFeHQpID09PSAnJykge1xyXG4gICAgcmV0dXJuIHBhdGhXaXRob3V0RXh0ICsgJy5zcWwnO1xyXG4gIH1cclxuICByZXR1cm4gcGF0aFdpdGhvdXRFeHQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGVzY2FwZVJlZ0V4cChzdHJpbmcpIHtcclxuICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoLyhbLiorP149IToke30oKXxcXFtcXF1cXC9cXFxcXSkvZywgJ1xcXFwkMScpO1xyXG59XHJcblxyXG5mdW5jdGlvbiByZXBsYWNlQWxsKHN0cmluZywgb3JpZ2luYWwsIHJlcGxhY2VkKSB7XHJcbiAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKG5ldyBSZWdFeHAoZXNjYXBlUmVnRXhwKG9yaWdpbmFsKSwgJ2cnKSwgcmVwbGFjZWQpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwcm9jZXNzTmV4dERpcmVjdGl2ZShvcHRzLCBzdGF0ZSkge1xyXG4gIGNvbnN0IHsgbGluZXNBbHJlYWR5UHJvY2Vzc2VkLCBsaW5lc1RvUHJvY2VzcyB9ID0gc3RhdGU7XHJcbiAgY29uc3QgaW5kZXhPZkZpcnN0RGlyZWN0aXZlID0gXy5maW5kSW5kZXgobGluZXNUb1Byb2Nlc3MsIChsaW5lKSA9PiBzdGFydHNXaXRoKGxpbmUsIERJUkVDVElWRV9QUkVGSVgpKTtcclxuICBpZihpbmRleE9mRmlyc3REaXJlY3RpdmUgPT09IC0xKSB7XHJcbiAgICBfLmVhY2gobGluZXNUb1Byb2Nlc3MsIChsaW5lKSA9PiBsaW5lc0FscmVhZHlQcm9jZXNzZWQucHVzaChsaW5lKSk7XHJcbiAgICByZXR1cm4gbGluZXNBbHJlYWR5UHJvY2Vzc2VkO1xyXG4gIH1cclxuICBjb25zdCBmaXJzdERpcmVjdGl2ZSA9IGxpbmVzVG9Qcm9jZXNzW2luZGV4T2ZGaXJzdERpcmVjdGl2ZV07XHJcbiAgY29uc3QgbGluZXNUb0lnbm9yZSA9IF8uc2xpY2UobGluZXNUb1Byb2Nlc3MsIDAsIGluZGV4T2ZGaXJzdERpcmVjdGl2ZSk7XHJcbiAgY29uc3QgbmV4dExpbmVzVG9Qcm9jZXNzID0gXy5zbGljZShsaW5lc1RvUHJvY2VzcywgaW5kZXhPZkZpcnN0RGlyZWN0aXZlKTtcclxuICBjb25zdCBwYXJhbXMgPSBmaXJzdERpcmVjdGl2ZS5tYXRjaChESVJFQ1RJVkVfUkVHRVhQKTtcclxuICBpZihwYXJhbXMgPT09IG51bGwpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihgVW5yZWNvZ25pemVkIGRpcmVjdGl2ZSBpbiAke3N0YXRlLmVudHJ5fTogJHtmaXJzdERpcmVjdGl2ZX1gKTtcclxuICB9XHJcbiAgY29uc3QgWywgZGlyZWN0aXZlTmFtZSwgZGlyZWN0aXZlQXJnc10gPSBwYXJhbXM7XHJcbiAgaWYoIV8uaGFzKGRpcmVjdGl2ZXMsIGRpcmVjdGl2ZU5hbWUpKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gZGlyZWN0aXZlIGluICR7c3RhdGUuZW50cnl9OiAke2RpcmVjdGl2ZU5hbWV9YCk7XHJcbiAgfVxyXG4gIGlmKF8uaW5jbHVkZXMob3B0cy5ibGFja2xpc3QsIGRpcmVjdGl2ZU5hbWUpKSB7XHJcbiAgICByZXR1cm4gZGlyZWN0aXZlcy5fbm9vcChvcHRzLCBzdGF0ZSk7XHJcbiAgfVxyXG4gIF8uZWFjaChsaW5lc1RvSWdub3JlLCAobGluZSkgPT4gbGluZXNBbHJlYWR5UHJvY2Vzc2VkLnB1c2gobGluZSkpO1xyXG4gIHN0YXRlLmxpbmVzVG9Qcm9jZXNzID0gbmV4dExpbmVzVG9Qcm9jZXNzO1xyXG4gIHJldHVybiBkaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdKG9wdHMsIHN0YXRlLCBkaXJlY3RpdmVBcmdzKTtcclxufVxyXG5cclxuZnVuY3Rpb24gcHJvY2Vzc1NpbmdsZUZpbGUob3B0cywgc3RhdGUpIHtcclxuICBjb25zdCB7IGVudHJ5LCBnbG9iYWxEZWNscywgbG9jYWxEZWNscyB9ID0gc3RhdGU7XHJcbiAgcmV0dXJuIGZzLnJlYWRGaWxlQXN5bmMoZW50cnkpXHJcbiAgLnRoZW4oKGNvbnRlbnRzKSA9PiB7XHJcbiAgICBjb25zdCBkZWNscyA9IE9iamVjdC5hc3NpZ24oe30sIGdsb2JhbERlY2xzLCBsb2NhbERlY2xzKTtcclxuICAgIGNvbnN0IGxpbmVzVG9Qcm9jZXNzID0gXy5yZWR1Y2UoZGVjbHMsIChjdXJyZW50LCBleHByLCBpZGVudGlmaWVyKSA9PlxyXG4gICAgICByZXBsYWNlQWxsKGN1cnJlbnQsIGV4cHIsIGlkZW50aWZpZXIpLFxyXG4gICAgcmVwbGFjZUFsbChjb250ZW50cy50b1N0cmluZyhvcHRzLmVuY29kaW5nKSwgJ1xcclxcbicsICdcXG4nKSkuc3BsaXQoJ1xcbicpO1xyXG4gICAgcmV0dXJuIHByb2Nlc3NOZXh0RGlyZWN0aXZlKG9wdHMsIE9iamVjdC5hc3NpZ24oc3RhdGUsIHsgbGluZXNBbHJlYWR5UHJvY2Vzc2VkOiBbXSwgbGluZXNUb1Byb2Nlc3MgfSkpO1xyXG4gIH0pO1xyXG59XHJcblxyXG5PYmplY3QuYXNzaWduKGRpcmVjdGl2ZXMsIHtcclxuICBfbm9vcChvcHRzLCBzdGF0ZSkge1xyXG4gICAgY29uc3QgeyBsaW5lc0FscmVhZHlQcm9jZXNzZWQsIGxpbmVzVG9Qcm9jZXNzIH0gPSBzdGF0ZTtcclxuICAgIGxpbmVzQWxyZWFkeVByb2Nlc3NlZC5wdXNoKGxpbmVzVG9Qcm9jZXNzLnNoaWZ0KCkpO1xyXG4gICAgcmV0dXJuIHByb2Nlc3NOZXh0RGlyZWN0aXZlKG9wdHMsIE9iamVjdC5hc3NpZ24oc3RhdGUsIHsgbGluZXNBbHJlYWR5UHJvY2Vzc2VkLCBsaW5lc1RvUHJvY2VzcyB9KSk7XHJcbiAgfSxcclxuXHJcbiAgcmVxdWlyZShvcHRzLCBzdGF0ZSwgcGF0aCkge1xyXG4gICAgY29uc3QgeyBhbHJlYWR5UmVxdWlyZWQsIGdsb2JhbERlY2xzLCBpbmNsdWRlU3RhY2sgfSA9IHN0YXRlO1xyXG4gICAgY29uc3QgY2hpbGRFbnRyeSA9IHJlc29sdmUob3B0cywgc3RhdGUsIHBhdGgpO1xyXG4gICAgaWYoXy5oYXMoYWxyZWFkeVJlcXVpcmVkLCBjaGlsZEVudHJ5KSkge1xyXG4gICAgICBjb25zdCB7IGxpbmVzQWxyZWFkeVByb2Nlc3NlZCwgbGluZXNUb1Byb2Nlc3MgfSA9IHN0YXRlO1xyXG4gICAgICBsaW5lc1RvUHJvY2Vzcy5zaGlmdCgpO1xyXG4gICAgICBsaW5lc0FscmVhZHlQcm9jZXNzZWQucHVzaChgLS0gUkVRVUlSRSBBTFJFQURZIFJFUVVJUkVEICR7cGF0aH1gKTtcclxuICAgICAgcmV0dXJuIHByb2Nlc3NOZXh0RGlyZWN0aXZlKG9wdHMsIE9iamVjdC5hc3NpZ24oc3RhdGUsIHsgbGluZXNBbHJlYWR5UHJvY2Vzc2VkLCBsaW5lc1RvUHJvY2VzcyB9KSk7XHJcbiAgICB9XHJcbiAgICBhbHJlYWR5UmVxdWlyZWRbY2hpbGRFbnRyeV0gPSB0cnVlO1xyXG4gICAgY29uc3QgY2hpbGRJbmNsdWRlU3RhY2sgPSBfLmNsb25lKGluY2x1ZGVTdGFjayk7XHJcbiAgICBjb25zdCBjaGlsZEdsb2JhbERlY2xzID0gXy5jbG9uZShnbG9iYWxEZWNscyk7XHJcbiAgICBjaGlsZEluY2x1ZGVTdGFjay5wdXNoKGNoaWxkRW50cnkpO1xyXG4gICAgY29uc3QgY2hpbGRTdGF0ZSA9IHtcclxuICAgICAgZW50cnk6IGNoaWxkRW50cnksXHJcbiAgICAgIGxpbmVzVG9Qcm9jZXNzOiBudWxsLFxyXG4gICAgICBsaW5lc0FscmVhZHlQcm9jZXNzZWQ6IG51bGwsXHJcbiAgICAgIGxvY2FsRGVjbHM6IHt9LFxyXG4gICAgICBnbG9iYWxEZWNsczogY2hpbGRHbG9iYWxEZWNscyxcclxuICAgICAgYWxyZWFkeVJlcXVpcmVkLFxyXG4gICAgICBpbmNsdWRlU3RhY2s6IGNoaWxkSW5jbHVkZVN0YWNrLFxyXG4gICAgfTtcclxuICAgIHJldHVybiBwcm9jZXNzU2luZ2xlRmlsZShvcHRzLCBjaGlsZFN0YXRlKVxyXG4gICAgLnRoZW4oKGNoaWxkTGluZXMpID0+IHtcclxuICAgICAgYWxyZWFkeVJlcXVpcmVkW2NoaWxkRW50cnldID0gY2hpbGRMaW5lcztcclxuICAgICAgY29uc3QgeyBsaW5lc0FscmVhZHlQcm9jZXNzZWQsIGxpbmVzVG9Qcm9jZXNzIH0gPSBzdGF0ZTtcclxuICAgICAgbGluZXNUb1Byb2Nlc3Muc2hpZnQoKTtcclxuICAgICAgbGluZXNBbHJlYWR5UHJvY2Vzc2VkLnB1c2goYC0tIFJFUVVJUkUgQkVHSU4gJHtwYXRofWApO1xyXG4gICAgICBfLmVhY2goY2hpbGRMaW5lcywgKGxpbmUpID0+IGxpbmVzQWxyZWFkeVByb2Nlc3NlZC5wdXNoKGxpbmUpKTtcclxuICAgICAgY29uc3QgbmV3R2xvYmFsRGVjbHMgPSB7fTtcclxuICAgICAgXy5lYWNoKGNoaWxkR2xvYmFsRGVjbHMsIChleHByLCBpZGVudGlmaWVyKSA9PiB7XHJcbiAgICAgICAgaWYoIV8uaGFzKGdsb2JhbERlY2xzLCBpZGVudGlmaWVyKSkge1xyXG4gICAgICAgICAgbmV3R2xvYmFsRGVjbHNbaWRlbnRpZmllcl0gPSBleHByO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIF8uZWFjaChsaW5lc1RvUHJvY2VzcywgKGxpbmUsIGspID0+XHJcbiAgICAgICAgXy5lYWNoKG5ld0dsb2JhbERlY2xzLCAoZXhwciwgaWRlbnRpZmllcikgPT5cclxuICAgICAgICAgIGxpbmVzVG9Qcm9jZXNzW2tdID0gcmVwbGFjZUFsbChsaW5lc1RvUHJvY2Vzc1trXSwgaWRlbnRpZmllciwgZXhwcilcclxuICAgICAgICApXHJcbiAgICAgICk7XHJcbiAgICAgIGxpbmVzQWxyZWFkeVByb2Nlc3NlZC5wdXNoKGAtLSBSRVFVSVJFIEVORCAke3BhdGh9YCk7XHJcbiAgICAgIHJldHVybiBwcm9jZXNzTmV4dERpcmVjdGl2ZShvcHRzLCBPYmplY3QuYXNzaWduKHN0YXRlLCB7IGxpbmVzQWxyZWFkeVByb2Nlc3NlZCwgbGluZXNUb1Byb2Nlc3MgfSkpO1xyXG4gICAgfSk7XHJcbiAgfSxcclxuXHJcbiAgaW5jbHVkZShvcHRzLCBzdGF0ZSwgcGF0aCkge1xyXG4gICAgY29uc3QgeyBnbG9iYWxEZWNscywgYWxyZWFkeVJlcXVpcmVkLCBpbmNsdWRlU3RhY2sgfSA9IHN0YXRlO1xyXG4gICAgY29uc3QgY2hpbGRFbnRyeSA9IHJlc29sdmUob3B0cywgc3RhdGUsIHBhdGgpO1xyXG4gICAgaWYoXy5pbmNsdWRlcyhpbmNsdWRlU3RhY2ssIGNoaWxkRW50cnkpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ3ljbGljIGluY2x1ZGUgaXMgbm90IGFsbG93ZWQ6ICR7cGF0aH1gKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGNoaWxkSW5jbHVkZVN0YWNrID0gXy5jbG9uZShpbmNsdWRlU3RhY2spO1xyXG4gICAgY2hpbGRJbmNsdWRlU3RhY2sucHVzaChjaGlsZEVudHJ5KTtcclxuICAgIGNvbnN0IGNoaWxkU3RhdGUgPSB7XHJcbiAgICAgIGVudHJ5OiBjaGlsZEVudHJ5LFxyXG4gICAgICBsaW5lc1RvUHJvY2VzczogbnVsbCxcclxuICAgICAgbGluZXNBbHJlYWR5UHJvY2Vzc2VkOiBudWxsLFxyXG4gICAgICBsb2NhbERlY2xzOiB7fSxcclxuICAgICAgZ2xvYmFsRGVjbHMsXHJcbiAgICAgIGFscmVhZHlSZXF1aXJlZCxcclxuICAgICAgaW5jbHVkZVN0YWNrOiBjaGlsZEluY2x1ZGVTdGFjayxcclxuICAgIH07XHJcbiAgICByZXR1cm4gcHJvY2Vzc1NpbmdsZUZpbGUob3B0cywgY2hpbGRTdGF0ZSlcclxuICAgIC50aGVuKChjaGlsZExpbmVzKSA9PiB7XHJcbiAgICAgIGNvbnNvbGUud2Fybih7IGNoaWxkTGluZXMgfSk7XHJcbiAgICAgIGNvbnN0IHsgbGluZXNBbHJlYWR5UHJvY2Vzc2VkLCBsaW5lc1RvUHJvY2VzcyB9ID0gc3RhdGU7XHJcbiAgICAgIGxpbmVzVG9Qcm9jZXNzLnNoaWZ0KCk7XHJcbiAgICAgIGxpbmVzQWxyZWFkeVByb2Nlc3NlZC5wdXNoKGAtLSBJTkNMVURFIEJFR0lOICR7Y2hpbGRFbnRyeX1gKTtcclxuICAgICAgXy5lYWNoKGNoaWxkTGluZXMsIChsaW5lKSA9PiBsaW5lc0FscmVhZHlQcm9jZXNzZWQucHVzaChsaW5lKSk7XHJcbiAgICAgIGxpbmVzQWxyZWFkeVByb2Nlc3NlZC5wdXNoKGAtLSBJTkNMVURFIEVORCAke2NoaWxkRW50cnl9YCk7XHJcbiAgICAgIHJldHVybiBwcm9jZXNzTmV4dERpcmVjdGl2ZShvcHRzLCBPYmplY3QuYXNzaWduKHN0YXRlLCB7IGxpbmVzQWxyZWFkeVByb2Nlc3NlZCwgbGluZXNUb1Byb2Nlc3MgfSkpO1xyXG4gICAgfSk7XHJcbiAgfSxcclxuXHJcbiAgZGVjbGFyZShvcHRzLCBzdGF0ZSwgYXJncykge1xyXG4gICAgY29uc3QgbWF0Y2ggPSBhcmdzLm1hdGNoKERFQ0xBUkVfUkVHRVhQKTtcclxuICAgIGlmKG1hdGNoID09PSBudWxsKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5yZWNvZ25pemVkIGRlY2xhcmU6ICR7YXJnc31gKTtcclxuICAgIH1cclxuICAgIGNvbnN0IFssIGxvY2FsT3JHbG9iYWwsIGlkZW50aWZpZXIsIGV4cHJdID0gbWF0Y2g7XHJcbiAgICBpZihsb2NhbE9yR2xvYmFsID09PSAnbG9jYWwnKSB7XHJcbiAgICAgIHN0YXRlLmxvY2FsRGVjbHNbaWRlbnRpZmllcl0gPSBleHByO1xyXG4gICAgfVxyXG4gICAgaWYobG9jYWxPckdsb2JhbCA9PT0gJ2dsb2JhbCcpIHtcclxuICAgICAgc3RhdGUuZ2xvYmFsRGVjbHNbaWRlbnRpZmllcl0gPSBleHByO1xyXG4gICAgfVxyXG4gICAgY29uc3QgeyBsaW5lc0FscmVhZHlQcm9jZXNzZWQsIGxpbmVzVG9Qcm9jZXNzIH0gPSBzdGF0ZTtcclxuICAgIGxpbmVzQWxyZWFkeVByb2Nlc3NlZC5wdXNoKGxpbmVzVG9Qcm9jZXNzLnNoaWZ0KCkpO1xyXG4gICAgXy5lYWNoKGxpbmVzVG9Qcm9jZXNzLCAobGluZSwgaykgPT4gbGluZXNUb1Byb2Nlc3Nba10gPSByZXBsYWNlQWxsKGxpbmUsIGlkZW50aWZpZXIsIGV4cHIpKTtcclxuICAgIHJldHVybiBwcm9jZXNzTmV4dERpcmVjdGl2ZShvcHRzLCBPYmplY3QuYXNzaWduKHN0YXRlLCB7IGxpbmVzQWxyZWFkeVByb2Nlc3NlZCwgbGluZXNUb1Byb2Nlc3MgfSkpO1xyXG4gIH0sXHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gcHJvY2Vzc0RpcmVjdGl2ZXMob3B0cywgZW50cnkpIHtcclxuICBfLmRlZmF1bHRzKG9wdHMsIGRlZmF1bHRPcHRzKTtcclxuICBjb25zdCBzdGF0ZSA9IHtcclxuICAgIGVudHJ5LFxyXG4gICAgbGluZXNUb1Byb2Nlc3M6IG51bGwsXHJcbiAgICBsaW5lc0FscmVhZHlQcm9jZXNzZWQ6IG51bGwsXHJcbiAgICBsb2NhbERlY2xzOiB7fSxcclxuICAgIGdsb2JhbERlY2xzOiB7fSxcclxuICAgIGFscmVhZHlSZXF1aXJlZDoge30sXHJcbiAgICBpbmNsdWRlU3RhY2s6IFtlbnRyeV0sXHJcbiAgfTtcclxuICByZXR1cm4gcHJvY2Vzc1NpbmdsZUZpbGUob3B0cywgc3RhdGUpXHJcbiAgLnRoZW4oKGxpbmVzKSA9PiBsaW5lcy5qb2luKCdcXG4nKSk7XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IHByb2Nlc3NEaXJlY3RpdmVzO1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
